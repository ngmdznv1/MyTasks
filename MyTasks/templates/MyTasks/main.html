{% extends 'base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block main %}
<div class="fade-in-up">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="text-center mb-5">
        <h1 class="page-title">
            <i class="bi bi-check2-square me-3 icon-bounce"></i>–í–∞—à–∏ –∑–∞–¥–∞—á–∏
        </h1>
        <p class="text-white-50 fs-5">–û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ —Å–≤–æ—é –∂–∏–∑–Ω—å —Å –ø–æ–º–æ—â—å—é —É–º–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8">
            <div class="glass-effect rounded-3 p-4">
                <h5 class="text-white mb-3">
                    <i class="bi bi-graph-up me-2"></i>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                </h5>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between text-white-50 mt-2">
                    <small>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span id="completedCount">0</span></small>
                    <small>–í—Å–µ–≥–æ: <span id="totalCount">0</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-container mb-5">
        <div class="stat-card hover-lift">
            <div class="stat-number" id="total-tasks">{{ tasks|length }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
            <i class="bi bi-list-task fs-1 text-primary mt-2"></i>
        </div>
        <div class="stat-card hover-lift">
            <div class="stat-number" id="active-tasks">0</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>
            <i class="bi bi-clock fs-1 text-warning mt-2"></i>
        </div>
        <div class="stat-card hover-lift">
            <div class="stat-number" id="completed-tasks">0</div>
            <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö</div>
            <i class="bi bi-check-circle fs-1 text-success mt-2"></i>
        </div>
        <div class="stat-card hover-lift">
            <div class="stat-number" id="overdue-tasks">0</div>
            <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö</div>
            <i class="bi bi-exclamation-triangle fs-1 text-danger mt-2"></i>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="text-center mb-4">
        <a href="{% url 'add_task' %}" class="btn btn-primary btn-lg pulse hover-glow">
            <i class="bi bi-plus-circle me-2 icon-spin"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        </a>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    {% if tasks %}
    <div class="row g-4" id="tasksContainer">
        {% for task in tasks %}
        <div class="col-lg-4 col-md-6">
            <div class="task-card {% if task.is_completed %}completed{% endif %} hover-lift cursor-grab" 
                 draggable="true" data-task-id="{{ task.id }}">
                {% if edit_task_id == task.id|stringformat:"s" %}
                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="task-card-header">
                    <h5 class="task-card-title">
                        <i class="bi bi-pencil me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="task_id" value="{{ task.id }}">
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" name="title" value="{{ task.title }}" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" class="form-control" rows="3" required>{{ task.description }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                            <input type="date" name="due_date" value="{{ task.due_date|date:'Y-m-d' }}" class="form-control" required>
                        </div>
                        <div class="task-actions">
                            <button type="submit" name="save_task" class="btn btn-success hover-lift">
                                <i class="bi bi-check-lg me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <a href="{% url 'main' %}" class="btn btn-outline-secondary hover-lift">
                                <i class="bi bi-x-lg me-1"></i>–û—Ç–º–µ–Ω–∞
                            </a>
                        </div>
                    </form>
                </div>
                {% else %}
                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
                <div class="task-card-header">
                    <h5 class="task-card-title">
                        <i class="bi bi-card-text me-2"></i>{{ task.title }}
                    </h5>
                    <div class="task-card-meta">
                        <i class="bi bi-calendar-event me-1"></i>{{ task.created_at|date:"d.m.Y" }}
                    </div>
                </div>
                <div class="card-body">
                    <p class="task-description">{{ task.description }}</p>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            –°—Ä–æ–∫: {{ task.due_date|date:"d.m.Y" }}
                            {% if task.due_date < today %}
                                <span class="badge bg-danger ms-2">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                            {% endif %}
                        </small>
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ -->
                    <div class="task-status">
                        <input type="checkbox" 
                               class="task-checkbox" 
                               name="completed" 
                               {% if task.is_completed %}checked{% endif %} 
                               onchange="toggleTaskStatus({{ task.id }}, this.checked)"
                               id="task-{{ task.id }}">
                        <label class="form-check-label fw-medium" for="task-{{ task.id }}">
                            {% if task.is_completed %}
                                <i class="bi bi-check-circle-fill text-success me-1"></i>–í—ã–ø–æ–ª–Ω–µ–Ω–æ
                            {% else %}
                                <i class="bi bi-circle me-1"></i>–í –ø—Ä–æ—Ü–µ—Å—Å–µ
                            {% endif %}
                        </label>
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="task-actions">
                        <form method="POST" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="edit_task_id" value="{{ task.id }}">
                            <button type="submit" class="btn btn-outline-primary btn-sm hover-lift">
                                <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </form>
                        
                        <button type="button" class="btn btn-outline-danger btn-sm hover-lift" 
                                onclick="confirmDelete({{ task.id }})">
                            <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div class="empty-state">
        <i class="bi bi-clipboard-check fs-1 icon-bounce"></i>
        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å!</p>
        <a href="{% url 'add_task' %}" class="btn btn-primary btn-lg hover-glow">
            <i class="bi bi-plus-circle me-2 icon-spin"></i>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É
        </a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal-backdrop" id="deleteModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            </h5>
        </div>
        <div class="modal-body">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?</p>
            <p class="text-muted">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                <i class="bi bi-x-lg me-1"></i>–û—Ç–º–µ–Ω–∞
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<script>
// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏
class TaskManager {
    constructor() {
        this.init();
    }

    init() {
        this.setupDragAndDrop();
        this.updateStatistics();
        this.updateProgress();
        this.setupAnimations();
    }

    setupDragAndDrop() {
        const taskCards = document.querySelectorAll('.task-card[draggable="true"]');
        
        taskCards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            });

            card.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
            });

            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            card.addEventListener('drop', (e) => {
                e.preventDefault();
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –∑–∞–¥–∞—á
                this.showNotification('–ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞!', 'success');
            });
        });
    }

    updateStatistics() {
        const cards = document.querySelectorAll('.task-card');
        let activeCount = 0;
        let completedCount = 0;
        let overdueCount = 0;
        
        cards.forEach(card => {
            if (card.classList.contains('completed')) {
                completedCount++;
            } else {
                activeCount++;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const dueDateText = card.querySelector('.text-muted');
            if (dueDateText && dueDateText.textContent.includes('–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ')) {
                overdueCount++;
            }
        });
        
        document.getElementById('active-tasks').textContent = activeCount;
        document.getElementById('completed-tasks').textContent = completedCount;
        document.getElementById('overdue-tasks').textContent = overdueCount;
        document.getElementById('totalCount').textContent = cards.length;
        document.getElementById('completedCount').textContent = completedCount;
    }

    updateProgress() {
        const total = parseInt(document.getElementById('totalCount').textContent);
        const completed = parseInt(document.getElementById('completedCount').textContent);
        const progress = total > 0 ? (completed / total) * 100 : 0;
        
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = progress + '%';
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        setTimeout(() => {
            progressBar.style.transition = 'width 1s ease';
        }, 500);
    }

    setupAnimations() {
        const cards = document.querySelectorAll('.task-card');
        
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }

    showNotification(message, type = 'info') {
        if (window.notificationManager) {
            window.notificationManager.show(message, type);
        }
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function toggleTaskStatus(taskId, isCompleted) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/task/${taskId}/mark_completed/`;
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const completedInput = document.createElement('input');
    completedInput.type = 'hidden';
    completedInput.name = 'completed';
    completedInput.value = isCompleted;
    
    form.appendChild(csrfToken);
    form.appendChild(completedInput);
    document.body.appendChild(form);
    form.submit();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (window.taskManager) {
        const message = isCompleted ? '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üéâ' : '–ó–∞–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É';
        const type = isCompleted ? 'success' : 'info';
        window.taskManager.showNotification(message, type);
    }
}

function confirmDelete(taskId) {
    const modal = document.getElementById('deleteModal');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    confirmBtn.onclick = () => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/task/${taskId}/delete/`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        form.appendChild(csrfToken);
        document.body.appendChild(form);
        form.submit();
    };
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    window.taskManager = new TaskManager();
});
</script>
{% endblock %}
